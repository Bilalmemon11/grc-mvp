// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  userRoles          UserRole[]
  organizationUsers  OrganizationUser[]
  auditLogs          AuditLog[]
  ownedControls      Control[]          @relation("ControlOwner")
  ownedRisks         Risk[]             @relation("RiskOwner")
  uploadedEvidence   Evidence[]
  createdFindings    Finding[]

  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  resource    String
  action      String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String   @map("role_id")
  permissionId String   @map("permission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// ============================================
// ORGANIZATIONS & TENANTS
// ============================================

model Organization {
  id        String   @id @default(uuid())
  name      String
  domain    String?  @unique
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organizationUsers    OrganizationUser[]
  frameworks           Framework[]
  controls             Control[]
  policies             Policy[]
  complianceChecks     ComplianceCheck[]
  risks                Risk[]
  audits               Audit[]
  evidence             Evidence[]
  aiInsights           AIInsight[]
  documentClassifications DocumentClassification[]
  anomalyDetections    AnomalyDetection[]

  @@map("organizations")
}

model OrganizationUser {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_users")
}

// ============================================
// COMPLIANCE FRAMEWORKS
// ============================================

model Framework {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  version        String?
  description    String?
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  controls         Control[]
  complianceRules  ComplianceRule[]
  audits           Audit[]

  @@unique([organizationId, name, version])
  @@map("frameworks")
}

model Control {
  id             String        @id @default(uuid())
  organizationId String        @map("organization_id")
  frameworkId    String        @map("framework_id")
  controlId      String        @map("control_id")
  title          String
  description    String?
  guidance       String?
  status         ControlStatus @default(NOT_STARTED)
  ownerId        String?       @map("owner_id")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  framework    Framework     @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  owner        User?         @relation("ControlOwner", fields: [ownerId], references: [id])
  policies     Policy[]
  evidence     Evidence[]
  riskControls RiskControl[]

  @@unique([frameworkId, controlId])
  @@map("controls")
}

enum ControlStatus {
  NOT_STARTED
  IN_PROGRESS
  IMPLEMENTED
  VERIFIED
}

model Policy {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  controlId      String?  @map("control_id")
  title          String
  description    String?
  fileUrl        String?  @map("file_url")
  version        String
  approvedAt     DateTime? @map("approved_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  control      Control?     @relation(fields: [controlId], references: [id])

  @@map("policies")
}

model ComplianceRule {
  id          String   @id @default(uuid())
  frameworkId String   @map("framework_id")
  name        String
  description String?
  ruleLogic   Json     @map("rule_logic")
  severity    String
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  framework        Framework         @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  complianceChecks ComplianceCheck[]

  @@map("compliance_rules")
}

model ComplianceCheck {
  id             String           @id @default(uuid())
  organizationId String           @map("organization_id")
  ruleId         String           @map("rule_id")
  status         ComplianceStatus
  score          Float?
  result         Json?
  executedAt     DateTime         @default(now()) @map("executed_at")

  // Relations
  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rule         ComplianceRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@map("compliance_checks")
}

enum ComplianceStatus {
  COMPLIANT
  NON_COMPLIANT
  PARTIALLY_COMPLIANT
  NOT_APPLICABLE
}

// ============================================
// RISK MANAGEMENT
// ============================================

model RiskCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  risks Risk[]

  @@map("risk_categories")
}

model Risk {
  id             String     @id @default(uuid())
  organizationId String     @map("organization_id")
  categoryId     String     @map("category_id")
  title          String
  description    String?
  likelihood     Int
  impact         Int
  inherentScore  Int        @map("inherent_score")
  residualScore  Int?       @map("residual_score")
  status         RiskStatus @default(IDENTIFIED)
  ownerId        String?    @map("owner_id")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  // Relations
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category         RiskCategory      @relation(fields: [categoryId], references: [id])
  owner            User?             @relation("RiskOwner", fields: [ownerId], references: [id])
  mitigationPlans  MitigationPlan[]
  riskControls     RiskControl[]
  aiInsights       AIInsight[]

  @@map("risks")
}

enum RiskStatus {
  IDENTIFIED
  ASSESSED
  MITIGATED
  CLOSED
  ACCEPTED
}

model MitigationPlan {
  id          String    @id @default(uuid())
  riskId      String    @map("risk_id")
  title       String
  description String?
  status      String
  dueDate     DateTime? @map("due_date")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  risk Risk @relation(fields: [riskId], references: [id], onDelete: Cascade)

  @@map("mitigation_plans")
}

model RiskControl {
  id        String   @id @default(uuid())
  riskId    String   @map("risk_id")
  controlId String   @map("control_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  risk    Risk    @relation(fields: [riskId], references: [id], onDelete: Cascade)
  control Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@unique([riskId, controlId])
  @@map("risk_controls")
}

// ============================================
// AUDIT MANAGEMENT
// ============================================

model Audit {
  id             String      @id @default(uuid())
  organizationId String      @map("organization_id")
  frameworkId    String?     @map("framework_id")
  name           String
  type           String
  status         AuditStatus @default(PLANNED)
  startDate      DateTime?   @map("start_date")
  endDate        DateTime?   @map("end_date")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  framework    Framework?   @relation(fields: [frameworkId], references: [id])
  evidence     Evidence[]
  findings     Finding[]

  @@map("audits")
}

enum AuditStatus {
  PLANNED
  IN_PROGRESS
  UNDER_REVIEW
  COMPLETED
}

model Evidence {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  auditId        String?  @map("audit_id")
  controlId      String?  @map("control_id")
  title          String
  description    String?
  fileUrl        String   @map("file_url")
  uploadedBy     String   @map("uploaded_by")
  uploadedAt     DateTime @default(now()) @map("uploaded_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  audit        Audit?       @relation(fields: [auditId], references: [id])
  control      Control?     @relation(fields: [controlId], references: [id])
  uploader     User         @relation(fields: [uploadedBy], references: [id])

  @@map("evidence")
}

model Finding {
  id          String         @id @default(uuid())
  auditId     String         @map("audit_id")
  title       String
  description String?
  severity    FindingSeverity
  status      FindingStatus  @default(OPEN)
  createdBy   String         @map("created_by")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  // Relations
  audit             Audit              @relation(fields: [auditId], references: [id], onDelete: Cascade)
  creator           User               @relation(fields: [createdBy], references: [id])
  remediationPlans  RemediationPlan[]

  @@map("findings")
}

enum FindingSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFORMATIONAL
}

enum FindingStatus {
  OPEN
  IN_REMEDIATION
  CLOSED
  ACCEPTED_RISK
}

model RemediationPlan {
  id          String    @id @default(uuid())
  findingId   String    @map("finding_id")
  title       String
  description String?
  status      String
  dueDate     DateTime? @map("due_date")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  finding Finding @relation(fields: [findingId], references: [id], onDelete: Cascade)

  @@map("remediation_plans")
}

// ============================================
// AI/ML FEATURES
// ============================================

model AIInsight {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  riskId         String?  @map("risk_id")
  insightType    String   @map("insight_type")
  content        String
  metadata       Json?
  confidence     Float?
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  risk         Risk?        @relation(fields: [riskId], references: [id])

  @@map("ai_insights")
}

model DocumentClassification {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  documentUrl    String   @map("document_url")
  category       String
  confidence     Float
  metadata       Json?
  classifiedAt   DateTime @default(now()) @map("classified_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("document_classifications")
}

model AnomalyDetection {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  anomalyType    String   @map("anomaly_type")
  description    String
  severity       String
  metadata       Json?
  detectedAt     DateTime @default(now()) @map("detected_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("anomaly_detections")
}

// ============================================
// AUDIT TRAIL
// ============================================

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  action      String
  resource    String
  resourceId  String?  @map("resource_id")
  changes     Json?
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  timestamp   DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@map("audit_logs")
  @@index([userId])
  @@index([resource, resourceId])
  @@index([timestamp])
}
